<!--pages/chat/chat.wxml-->
<view class="container chat-page">
  <!-- 1. è‡ªå®šä¹‰å¯¼èˆªæ  (ä¸è¯¦æƒ…é¡µä¸€è‡´) -->
  <view class="chat-nav" style="height: {{navTotalHeight}}px;">
    <view class="nav-content-wrapper" style="top: {{navContentTop}}px; height: {{navContentHeight}}px;">
      <view class="nav-left" bindtap="onNavBack">
        <view class="icon-back"></view>
      </view>
      
      <view class="nav-center">
        <text class="chat-nickname">{{userInfo.nickname}}</text>
      </view>
      
      <!-- åŠŸèƒ½èœå• (å…¥å£) -->
      <view class="nav-right" bindtap="onMoreOptions">
        <view class="icon-more">Â·Â·Â·</view>
      </view>
      
      <!-- å³ä¾§ç©ºå‡ºèƒ¶å›Šä½ç½® -->
      <view class="nav-right-placeholder" style="width: {{menuButtonWidth}}px;"></view>
    </view>
  </view>

  <!-- 2. èŠå¤©åŒº -->
  <scroll-view 
    scroll-y 
    class="chat-scroll" 
    scroll-into-view="{{lastMessageId}}" 
    scroll-with-animation
    style="padding-top: {{navTotalHeight}}px; padding-bottom: calc(120rpx + env(safe-area-inset-bottom));"
  >
    <view class="chat-content">
      <block wx:for="{{messages}}" wx:key="id">
        <!-- æ—¶é—´çº¿ -->
        <view class="time-stamp" wx:if="{{item.showTime}}">{{item.time}}</view>

        <!-- æ¶ˆæ¯æ°”æ³¡ (å·¦/å³) -->
        <view class="message-row {{item.isMe ? 'row-me' : 'row-other'}}" id="msg-{{item.id}}">
          <image class="avatar" src="{{item.avatar || '/images/default-avatar.png'}}" mode="aspectFill"></image>
          
          <view class="bubble-wrapper">
            <view class="bubble {{item.type === 'image' ? 'bubble-image' : ''}}">
              <text wx:if="{{item.type === 'text'}}" user-select>{{item.content}}</text>
              <image 
                wx:if="{{item.type === 'image'}}" 
                src="{{item.content}}" 
                mode="widthFix" 
                class="msg-image"
                bindtap="onPreviewImage"
                data-src="{{item.content}}"
              />
            </view>
          </view>
        </view>
      </block>
      
      <!-- åº•éƒ¨æ’‘å¼€ -->
      <view id="bottom-pad" style="height: 40rpx;"></view>
    </view>
  </scroll-view>

  <!-- 3. åº•éƒ¨è¾“å…¥æ  (Neobrutalism) -->
  <view class="input-bar" style="bottom: {{keyboardHeight}}px;">
    <!-- è¯­éŸ³æŒ‰é’® -->
    <view class="icon-btn voice-btn">
      <text>ğŸ™ï¸</text>
    </view>

    <!-- è¾“å…¥æ¡† -->
    <view class="input-wrapper">
      <input 
        class="chat-input" 
        placeholder="è¯´ç‚¹ä»€ä¹ˆ..." 
        cursor-spacing="20"
        confirm-type="send"
        bindconfirm="onSend"
        bindinput="onInput"
        bindfocus="onFocus"
        bindblur="onBlur"
        value="{{inputValue}}"
        adjust-position="{{false}}"
      />
    </view>

    <!-- è¡¨æƒ…æŒ‰é’® -->
    <view class="icon-btn emoji-btn">
      <text>ğŸ˜Š</text>
    </view>

    <!-- æ›´å¤šæŒ‰é’® (+) -->
    <view class="icon-btn more-btn" bindtap="onToggleTools">
      <text>+</text>
    </view>
  </view>

  <!-- æ›´å¤šåŠŸèƒ½é¢æ¿ (åº•éƒ¨å¼¹çª—/æ‰©å±•æ ) -->
  <view class="tools-panel" wx:if="{{showTools}}" style="height: 300rpx;">
    <view class="tool-item" bindtap="onChooseImage">
      <view class="tool-icon">ğŸ–¼ï¸</view>
      <text class="tool-text">ç›¸å†Œ</text>
    </view>
    <view class="tool-item" bindtap="onTakePhoto">
      <view class="tool-icon">ğŸ“·</view>
      <text class="tool-text">æ‹æ‘„</text>
    </view>
    <view class="tool-item" bindtap="onSendLocation">
      <view class="tool-icon">ğŸ“</view>
      <text class="tool-text">ä½ç½®</text>
    </view>
  </view>

</view>